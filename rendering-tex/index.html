<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.2f1cde8f96853bef9323.css">.header{position:fixed;top:0;left:0;width:100%;height:48px;background:#f5efed;border-bottom:1px solid #ddd;z-index:1000}.header-wrapper{margin:0 auto;max-width:800px}.logo a{display:-ms-flexbox;display:flex;height:48px;line-height:48px;-ms-flex-pack:center;justify-content:center;-ms-flex-align:center;align-items:center}.logo img{width:24px;height:24px;opacity:.4}.nav-container{position:absolute;top:0;left:0;width:100%;pointer-events:none}.nav-toggle{-webkit-appearance:none;margin:0;padding:0 1rem;height:48px;font-size:2rem;line-height:1;background:transparent;border:0}.nav,.nav-toggle{pointer-events:auto}.nav{position:absolute;top:48px;left:0;width:100%;max-height:0;background:#fff;-webkit-transition:max-height .3s ease;transition:max-height .3s ease;overflow:hidden}.nav-opened .nav{max-height:300px;border-bottom:1px solid #ddd;-webkit-box-shadow:0 4px 8px -4px rgba(0,0,0,.3);box-shadow:0 4px 8px -4px rgba(0,0,0,.3)}.nav ul{margin:0;padding:1rem 2rem;list-style:none}.nav ul li{margin-bottom:1rem;border-bottom:1px dashed #ddd}@media (min-width:768px){.header-wrapper{display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center;-ms-flex-line-pack:center;align-content:center}.nav-container{position:static}.nav-toggle{display:none}.nav{width:100%;position:static;max-height:none;background:transparent}.nav ul{margin-left:2rem;padding:0;display:-ms-flexbox;display:flex}.nav ul li{margin-bottom:0;padding:0 1rem;border-bottom:0}}

/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}main{display:block}h1{font-size:2em;margin:.67em 0}hr{-webkit-box-sizing:content-box;box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{-webkit-box-sizing:border-box;box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{-webkit-box-sizing:border-box;box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden],template{display:none}*{-webkit-box-sizing:border-box;box-sizing:border-box}html{height:100%}body{margin:0}body,button,input,textarea{font:16px/1.7 Arial,Helvetica,Tahoma,MiscroSoft Yahei,sans-serif}.wrapper{margin:0 auto;padding:20px;max-width:800px}a:link,a:visited{text-decoration:none;color:#066d63;-webkit-transition:.2s;transition:.2s}a:active,a:hover{color:#ff5e1f}.main{margin-top:48px}.copyright{text-align:center}.post-list article{margin-top:1rem}.post-list h1{margin:0;font-weight:400;font-size:20px}.post-list .post-meta{margin:0}.post-list .year-label{margin:2rem 0 0;font-family:serif;font-size:1.5rem;color:#aaa}@media (min-width:768px){.post-list article{display:-ms-flexbox;display:flex;-ms-flex-pack:justify;justify-content:space-between;-ms-flex-align:center;align-items:center;border-bottom:1px dotted #aaa}.post-list .post-meta{margin:0}}.footer{-ms-flex-pack:center;justify-content:center;-ms-flex-line-pack:center;align-content:center;padding:10px 5px 5px}.notice-container{display:-ms-flexbox;display:flex;-ms-flex-wrap:wrap;flex-wrap:wrap;-ms-flex-pack:justify;justify-content:space-between;-ms-flex-line-pack:center;align-content:center;-ms-flex-align:center;align-items:center;margin-top:25px}@media (max-width:640px - 1px){.notice-container{-ms-flex-pack:distribute;justify-content:space-around}}.notice-container h4{text-align:center;margin:0}.collection h2{font-weight:400px;font-size:1.25rem}.image-list{margin:1rem 0;padding:0;display:-ms-flexbox;display:flex;-ms-flex-wrap:wrap;flex-wrap:wrap;list-style:none}.image-list>li{margin:0;padding:.5rem;width:50%;font-size:0}.image-list img{max-width:100%;height:auto;background:#eee}.post-tag{display:inline-block;margin-right:10px;margin-bottom:10px;padding:4px 10px;background:#eee}code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::-moz-selection,code[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{text-shadow:none;background:#b3d4fc}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.post-entry{color:#333}.post-entry .post-title{margin:1em 0}.post-entry h1,.post-entry h2,.post-entry h3,.post-entry h4,.post-entry h5,.post-entry h6{margin:1.5em 0 .6em}.post-entry h1{font-size:1.75em}.post-entry h2{font-size:1.5em}.post-entry h3{font-size:1.25em}.post-entry h4{font-size:1em}.post-entry h5{font-size:.875em}.post-entry h6{font-size:.75em}.post-entry img{margin:0 auto;max-width:100%}.post-entry a{word-break:break-all}.post-entry blockquote{margin-left:0;margin-right:0;padding:.5em 1em;border-left:5px solid #ddd;background:#f8f8f8}.post-entry p{margin:0 0 1em}.post-entry ol,.post-entry ul{margin:1em 0;padding:0 0 0 1em}.post-entry li{margin-bottom:.5em;line-height:1.6}.post-entry code{display:inline-block;margin:0 1px;padding:2px 3px;line-height:1;background:#f4f4f4;border:1px solid #eaeaea;border-radius:2px}.post-entry pre{padding:.5em 1em;font-size:.875em;background:#f6f6f6;border-top:1px dotted #d8d8d8;border-bottom:1px dotted #d8d8d8}.post-entry pre>code{margin:0;padding:0;line-height:1.6;background:transparent;border:0;border-radius:0}.post-meta{margin:1em 0;color:#777;font-size:14px}</style><meta name="generator" content="Gatsby 2.24.65"/><title data-react-helmet="true">公式渲染方案 | 小曹哥的博客</title><link data-react-helmet="true" rel="icon" type="image/png" href="/favicon/favicon.png"/><meta data-react-helmet="true" name="description" content="…"/><meta data-react-helmet="true" name="image" content="https://xiaocaoge.com/"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect" href="https://www.google-analytics.com"/><link rel="dns-prefetch" href="https://www.google-analytics.com"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link rel="icon" href="/favicon-32x32.png?v=5de715cd48e16ef31bd58dde51af9393" type="image/png"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#c62828"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=5de715cd48e16ef31bd58dde51af9393"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=5de715cd48e16ef31bd58dde51af9393"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=5de715cd48e16ef31bd58dde51af9393"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=5de715cd48e16ef31bd58dde51af9393"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=5de715cd48e16ef31bd58dde51af9393"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=5de715cd48e16ef31bd58dde51af9393"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=5de715cd48e16ef31bd58dde51af9393"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=5de715cd48e16ef31bd58dde51af9393"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><link as="script" rel="preload" href="/webpack-runtime-b41fbae1d29ee5b41ef7.js"/><link as="script" rel="preload" href="/framework-29ba174b433dc5858bed.js"/><link as="script" rel="preload" href="/app-4ca4cdb0b81d091201b6.js"/><link as="script" rel="preload" href="/styles-e9d24b1846c7d6eb9685.js"/><link as="script" rel="preload" href="/cbe7a9b78343c4339878faffb2370c8f01a24eb8-e5585bd4b8dc51e026d6.js"/><link as="script" rel="preload" href="/598123994386a30265f4eb7d719394eaca6f5941-b24c4007fa513d16f229.js"/><link as="script" rel="preload" href="/component---src-templates-post-jsx-523f77b7a81851e804eb.js"/><link as="fetch" rel="preload" href="/page-data/rendering-tex/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div><header class="header"><div class="header-wrapper"><div class="logo"><a href="/"><img src="/favicon/favicon.png" alt="Site logo" title="小曹哥的博客"/></a></div><div class="nav-container"><button class="nav-toggle" htmltype="button">≡</button><nav class="nav"><ul><li><a href="/">文章</a></li><li><a href="/openSource">开源</a></li><li><a href="https://onetool.net" target="_blank" rel="noopener noreferrer">在线小工具</a></li><li><a href="/about">关于</a></li></ul></nav></div></div></header><div class="main"><div class="wrapper"><div class="post-entry"><h1 class="post-title">公式渲染方案</h1><div class="post-meta">发布于：<time dateTime="2018-12-31">2018-12-31</time></div><div><p>我在写博客主题时，经常会列出来可能会使用哪些信息表现形式，几乎所有内容发布平台都支持的有：文字、图片、超链接。但是，我作为编程人员，代码也应当支持。然后，还有很多其他形式要考虑：音频、视频、公式等等，不仅仅要支持，还要考虑支持到什么程度，用户体验会更好些。大体上，信息可能会有如下表现形式：</p>
<ul>
<li>文字</li>
<li>图片</li>
<li>表格</li>
<li>音频</li>
<li>视频</li>
<li>公式</li>
<li>代码</li>
<li>等等</li>
</ul>
<p>另外，还有可编辑代码、可交互式动画、VR 等表现形式，乃至游戏也算一种。不过有些几乎所有场景都需要的，有些特定场景才需要。</p>
<p>公式作为知识的重要组成部分，很多场景也都需要，尤其数学和物理相关领域，比如百科网站、问答网站、在线教育网站、内容发布平台、论文、书籍等。而现在信息展现的媒介也是多种多样，有书籍、电脑、平板、手机等。一些与公式展示相关的指标有：网络传输速率、屏幕尺寸、像素密度、字体的支持等。</p>
<p>公式通常使用特定的标记语言来书写，比如 TeX。<a href="https://en.wikipedia.org/wiki/TeX">TeX</a> 是数学家和计算机科学家 <a href="https://en.wikipedia.org/wiki/Donald_Knuth">Donald Knuth</a> 设计的一个排版系统，广泛用于数学、计算机科学等领域的公式排版。</p>
<p>公式的渲染要考虑下面问题：</p>
<ul>
<li>屏幕尺寸：从手机到宽屏桌面显示器，也包括书籍。</li>
<li>屏幕像素密度：有时公式可能以栅格图片展示，要考虑到高像素密度屏幕，随着技术发展也会越来越高。</li>
<li>性能：我们可能会一次性渲染很多公式，也包括非常复杂的公式，我们期望能尽快高质量将渲染好的公式呈现给用户。</li>
</ul>
<p>按照渲染的设备划分可有三种方式：客户端渲染、服务端渲染、客户端与服务端混合渲染。</p>
<h2 id="客户端渲染" style="position:relative;"><a href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%B8%B2%E6%9F%93" aria-label="客户端渲染 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>客户端渲染</h2>
<p>顾名思义，用户端渲染，有电脑、手机、平板等。应用类型主要是：原生应用与 Web 应用。当然，因为两类应用都支持图片，所以可以使用图片形式来展现公式。</p>
<p>无论是桌面端还是移动端原生应用，因为无相关经验，不太了解，客户端渲染公式方式。Github 上面可以搜到一些渲染公式的包，但是对于可靠性不太了解。</p>
<p>Web 应用主要使用 <a href="https://www.mathjax.org/">MathJax</a> 与 <a href="https://katex.org/">KaTeX</a> 两个包。</p>
<p><strong>MathJax</strong></p>
<ul>
<li>高质量：精确到像素的排版</li>
<li>支持 LaTeX，MathML 等语言</li>
<li>可扩展</li>
<li>可靠性：无论是从开发者背景，还是使用者背景，都是经过多年检验的</li>
<li>可访问性</li>
<li>渲染速度慢：尤其遇到复杂的公式时</li>
</ul>
<p><strong>KaTeX</strong></p>
<ul>
<li>渲染速度极快：大约 10 倍于 MathJax</li>
<li>可靠性：可汗学院开发与使用</li>
<li>渲染质量：满足大部分需求</li>
</ul>
<p>可以查看 <a href="http://www.intmath.com/cg5/katex-mathjax-comparison.php">compare the output of KaTeX with MathJax</a> 两者的渲染速度与渲染效果。</p>
<p><strong>另外，在实际的使用当中，结合使用两者效果更好，优先使用 KaTeX 来渲染，如果渲染失败就是用 MathJax 来渲染。</strong></p>
<h2 id="服务端渲染" style="position:relative;"><a href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93" aria-label="服务端渲染 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务端渲染</h2>
<p>即使结合使用了 KaTeX 和 MathJax，有些时候仍然不能满足要求，用户不希望等三秒以上才能渲染好公式。通常，公式的数量也是有限度的，按照一亿用户，每人贡献 100 个公式，那就是大约 100 亿条公式，可能还有一些重复的。没有必要用户每次查看时都重复渲染一遍，也没有必要在用户的设备上面各自渲染。</p>
<p>缩减计算时间的第一条规则就是<strong>空间换时间</strong>，也称之为<strong>缓存</strong>。</p>
<p>公式通常使用 TeX 标记语言来书写，输出结果通常有：HTML、MathML、图片，其中图片又分栅格图片（png、jpg、webp）和矢量图片（svg）。输出结果自然是计算的结果，然后可以使用分布式缓存（如CDN）来分发这些输出结果。</p>
<h3 id="接口设计" style="position:relative;"><a href="#%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1" aria-label="接口设计 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>接口设计</h3>
<h4 id="创建公式对象" style="position:relative;"><a href="#%E5%88%9B%E5%BB%BA%E5%85%AC%E5%BC%8F%E5%AF%B9%E8%B1%A1" aria-label="创建公式对象 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建公式对象</h4>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">POST /equations</code></pre></div>
<ul>
<li>
<p>请求参数：</p>
<ul>
<li>input：可选，输入格式，比如 tex，mathml, asciimath，默认 tex。</li>
<li>output：可选，输出格式，可选值：svg, png, mathml, html 等，可以多个组合，默认 svg。</li>
</ul>
</li>
<li>
<p>请求内容：</p>
<ul>
<li>公式标记语言。</li>
</ul>
</li>
<li>返回值：公式对象 ID。</li>
</ul>
<p>接受公式标记语言，比如 TeX、MathML、AsciiMath 等，分配一个唯一标识 ID，然后渲染公式为指定的一个活多个输出格式，公式输入与渲染结果都存储起来，可能还包括自动分发 CDN。</p>
<h4 id="获取公式对象" style="position:relative;"><a href="#%E8%8E%B7%E5%8F%96%E5%85%AC%E5%BC%8F%E5%AF%B9%E8%B1%A1" aria-label="获取公式对象 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>获取公式对象</h4>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">GET /equations/:equationId</code></pre></div>
<ul>
<li>
<p>请求参数：</p>
<ul>
<li>output：输出格式。</li>
</ul>
</li>
<li>返回值：公式渲染结果</li>
</ul>
<h3 id="渲染服务" style="position:relative;"><a href="#%E6%B8%B2%E6%9F%93%E6%9C%8D%E5%8A%A1" aria-label="渲染服务 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>渲染服务</h3>
<p>可以使用 Node 来运行 MathJax 或者 KaTeX，并结合 Puppeteer 来转成图片，当然这种方式性能不高，不过基本需求可以满足。如果对于渲染服务性能要求很高，可以考虑自己写 TeX 渲染组件或者考虑其他语言的 TeX 渲染组件，这方面不太了解，只知道维基百科就是自己写的 TeX 渲染组件。</p>
<h3 id="性能" style="position:relative;"><a href="#%E6%80%A7%E8%83%BD" aria-label="性能 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>性能</h3>
<ul>
<li>使用 CDN，可以多域名来突破浏览器同时请求数最大上限。</li>
<li>图片延迟加载：即公式图片将要进入可视区域再加载。</li>
</ul>
<h3 id="栅格图片与矢量图片" style="position:relative;"><a href="#%E6%A0%85%E6%A0%BC%E5%9B%BE%E7%89%87%E4%B8%8E%E7%9F%A2%E9%87%8F%E5%9B%BE%E7%89%87" aria-label="栅格图片与矢量图片 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>栅格图片与矢量图片</h3>
<p>因为屏幕的像素密度有高有低，而栅格图片放大与缩小通常采用插值算法，这样会造成模糊，可以针对不同像素密度生成不同的图片来解决。如果使用矢量图片（比如 SVG）就可以无限缩放。</p>
<h2 id="混合渲染" style="position:relative;"><a href="#%E6%B7%B7%E5%90%88%E6%B8%B2%E6%9F%93" aria-label="混合渲染 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>混合渲染</h2>
<p>即时我们采用了服务端渲染，并且做了一些性能优化，如果一个页面有很多公式，可能几十上百个，有简单的，也有复杂的。如果每个简单的公式都发送一个单独的请求，对于网络环境较差的客户端可能会加载慢，降低用户体验。</p>
<p>可以将简单的公式与复杂的公式区分开：简单的公式使用客户端渲染，复杂的公式使用服务端渲染。简单与复杂划分的界限可能是由<code class="language-text">公式标记语言字节数传输时间</code>加上<code class="language-text">公式客户端渲染时间</code>与<code class="language-text">公式单独一个请求传输时间</code>比较来决定。</p>
<h2 id="可搜索性" style="position:relative;"><a href="#%E5%8F%AF%E6%90%9C%E7%B4%A2%E6%80%A7" aria-label="可搜索性 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>可搜索性</h2>
<p>常见的搜索功能都是输入一些关键词，根据关键词匹配，也有搜索引擎支持图片搜索。简单的文本输入很难满足公式，而如果让用户使用 TeX 之类标记语言输入公式又才繁琐，可以通过手写公式，然后以图片形式传给搜索服务，可能会经过手写识别、公式识别等一系列解析，然后解析成某种格式，比如 TeX，然后使用 TeX 标记语言来匹配，至于匹配算法也会与常见的字符串匹配不同吧。</p>
<p>公式渲染不仅仅输出图片，也要输出其他标记语言，比如 MathML，然后便于搜索爬虫抓取，然后用于识别匹配。</p>
<p>目前一些国内拍题搜答案的移动应用比较类似，上传题目图片搜结果，这方面特别依赖人工智能相关技术，</p></div><div class="post-meta"><div class="post-tag-container"><a class="post-tag" style="text-decoration:none" href="/tags/公式">公式</a><a class="post-tag" style="text-decoration:none" href="/tags/te-x">TeX</a></div></div></div></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-49539922-1', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/rendering-tex/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-e82a74f5b9c5c449674e.js"],"app":["/app-4ca4cdb0b81d091201b6.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-ad6431e4664bcf916d19.js"],"component---src-pages-about-jsx":["/component---src-pages-about-jsx-597246824a107475a219.js"],"component---src-pages-index-jsx":["/component---src-pages-index-jsx-e6578ab14dc5bd9704d2.js"],"component---src-pages-open-source-jsx":["/component---src-pages-open-source-jsx-7321db2fa241d15aa70f.js"],"component---src-pages-photography-jsx":["/component---src-pages-photography-jsx-f633ff06d9301fc74b46.js"],"component---src-templates-category-jsx":["/component---src-templates-category-jsx-2179ab9b65398f61888e.js"],"component---src-templates-post-jsx":["/component---src-templates-post-jsx-523f77b7a81851e804eb.js"],"component---src-templates-tag-jsx":["/component---src-templates-tag-jsx-b6db8254f662d762027b.js"]};/*]]>*/</script><script src="/polyfill-e82a74f5b9c5c449674e.js" nomodule=""></script><script src="/component---src-templates-post-jsx-523f77b7a81851e804eb.js" async=""></script><script src="/598123994386a30265f4eb7d719394eaca6f5941-b24c4007fa513d16f229.js" async=""></script><script src="/cbe7a9b78343c4339878faffb2370c8f01a24eb8-e5585bd4b8dc51e026d6.js" async=""></script><script src="/styles-e9d24b1846c7d6eb9685.js" async=""></script><script src="/app-4ca4cdb0b81d091201b6.js" async=""></script><script src="/framework-29ba174b433dc5858bed.js" async=""></script><script src="/webpack-runtime-b41fbae1d29ee5b41ef7.js" async=""></script></body></html>