---
title: "编辑器类应用漫谈"
cover: ""
date: "2020-08-15"
category: "编程"
tags:
  - "编辑器"
  - "富文本"
  - "跨平台"
---

随着信息时代的不断发展，涌现出来了越来越多编辑器类应用，解决着用户的各种不同需求。何为编辑器类应用呢？比如我们最开始学习 Windows 系统时的记事本就是一个简单的文本编辑器，画图应用就是一个简单的图像编辑器。后来，我们开始学习 Office 三剑客——Word、Excel、PowerPoint，这样的功能强大的文档编辑器、表格编辑器或者幻灯片编辑器。再后来我们可能会接触 Photoshop 这样强大专业的图像编辑器、Premiere 视频编辑器、VS Code 代码编辑器等等。其实还有一些被忽略或没有意识到的应用也是编辑器类应用，比如美图秀秀、抖音视频编辑、微信在线排版工具、H5 编辑器等。这些编辑器类应用虽然完成的任务不同，有些都有基本的文本编辑功能，有些相差甚远，但有着很多相似的地方，相似的架构本质，这些相似的地方就是本文要谈得东西。当然了，由于自己经验十分粗浅，所以本文也只能算是抛砖引玉了。

**为什么要写这篇文章呢？**主要是作为过去某段功能的总结和思考记录，另外就是个人觉得编辑器类应用会越来越多，形式也会越来越丰富，然而编辑器类应用有属于自己领域特有的一些东西，这些不是通用前端或后端所涵盖的领域，所以这篇文章用来指导开发编辑器类应用，提升开发效率。

## 架构

编辑器本质上就是对**特定格式数据**的**渲染**，并通过**输入设备**（鼠标、键盘、画板）调用编辑器提供的**命令**（菜单栏、工具栏、快捷键)来对数据进行**变更**。

### 数据格式

编辑器操作的对象，称为**作品**，都有自己的特定格式，这个格式规范的制订是其他一切的基石。

#### 数据格式版本

实践中很难一次就制定出完美的数据格式规范，毕竟未来的需求很难预料，所以需要一开始就考虑数据格式的版本升级问题，这个和源码版本管理类似。比如借鉴语义化版本理念，版本号是一个`x.y.z`字符串，`x`表示主版本号，不兼容升级时此数字增加，`y`是次版本号，增加功能时此数字增加，`z`是修订版本号，修改 bug 时此数字增加。在数据格式规范变更时，可能需要增加新的变更函数，或者一些兼容性处理代码。

#### 作品是否为一个包含所有数据的文件

传统的编辑器保存在结果是一个文件，该文件有自己的格式规范，比如 txt 纯文本文件、Word 文档文件、jpg 图片文件，这些文件本身打包了所有的数据。

另外一种方式是作品文件不包含依赖的素材信息，素材是指图片、音频、视频或者其他自定义东西。作品文件只是一个特定格式的 JSON 文件，然后包含依赖素材的 URL 信息，这些素材单独存储、单独管理，也便于优化和单独处理，相同素材还便于引用同一份。这种方式与一个文件包括所在数据的方式对比起来，一个劣势就是离线处理，因为对网络有很强依赖。或者两种方式也不失为一个方法。

#### 作品历史版本

用户通常会多次编辑同一份作品，于是产生了不同的历史版本，有时候需要提供还原历史版本的功能，所以需要一开始就规划好如何存储历史版本，比如最简单的多个文件形式（file_v1.txt、file_v2.txt等），又或者借鉴 Git 的设计，可以节省存储空间。

#### 存储


#### 压缩

压缩的目的是为了降低**存储占用**以及**网络传输字节**。这里主要讨论文本数据压缩，图片与音视频等常用格式本身就是压缩格式。文本数据压缩采用常见的通用型 gzip、brotli 算法已经能大幅降低字节大小了，当然针对重复字段出现多的文本数据，采用 LZ 压缩算法能实现更高的压缩率，比如 [lz-string](https://github.com/pieroxy/lz-string)。对于大部分情况，这些算法基本能满足需求，如果有特殊需求也可以自行实现特定压缩算法。

#### 加密

加密需求不是很常见，但是在解决某些特殊问题时会使用到，比如反作弊、反爬虫，这也会涉及到产品的盈利。我之前工作遇到过有人从收费用户拷贝作品数据到免费用户的方式来使用一些收费功能。

### 跨平台

如今，很多应用存在跨平台需求，而且平台种类很多，包括下面几类：

* 桌面端：三大操作系统 Windows、macOS、Linux
* 移动端：Android、iOS、iPadOS、小程序
* 智能穿戴：主要就是智能手表
* 终端：通过命令行来操作

另外桌面端和移动端应用又分原生开发、跨平台技术、Web(自带跨平台)三大类别。目前跨平台技术也是在不断发展涌现，比如 React Native、Flutter、Xamarin、Electron、QT、uni-app、taro 等。

针对上面的架构图可以分析下如何达到**复用**，以提升开发效率：

* **数据格式**：这个对所有平台都是可复用的。
* **变更函数**：变更函数的执行大部分在客户端，理论上所在的平台其变更函数逻辑应该是相同的，应该复用的，但是因为不同语言问题，无法或者不是很容易做到复用，一些跨平台技术可以做到部分平台复用代码。随着跨平台技术的发展可以越来越容易解决这个问题，即一份代码多个平台运行。
* **视图**：这里是最复杂最难于复用的，主要是桌面端与移动端因屏幕大小问题导致的界面设计区别很大，交互逻辑也不同，所以移动端与桌面端应区别对待，当然了，部分逻辑也是可以复用的。

### 扩展性

## 相关应用或技术

### 典型编辑器应用

### 编辑器相关开源项目

## 可视化界面

我们这里谈论的是典型的具有可视化界面的编辑器，而不是像 Vim 一样大量依赖快捷键命令代码编辑器，尽管其本质相同。当然，对数据的变更不仅可以通过编辑器也可以通过编程方式，编程更改过程也是类似的，先读取并解析，然后调用方法之类进行修改。

桌面编辑器应用发展至今，界面有很多共同的元素：窗口、菜单栏、工具栏、工具面板、导航栏、内容区、状态栏以及一系列弹窗等。而移动端编辑器应用因为屏幕面积以及交互方式的不同，其界面与桌面编辑器有很大不同，这个最后简单说下。

### 窗口

相信所有使用多年电脑的人对于窗口都不陌生，可以说所有可视化应用都通过窗口形式来提供，窗口具有基本的关闭、最大化、最小化、缩放、平移等基本功能。

### 菜单栏

位于窗口顶部，下拉菜单形式提供各种命令，比如文件的创建、保存、导出，又比如编辑的撤销、重做等，编辑器提供的大部分命令这里都有。但是因为下拉菜单的交互形式导致操作效率比较低，所以只有个别命令会经常使用到，另外还提供了快捷键或工具栏形式调用相同的命令。

### 工具栏

通常位于菜单栏下面，由各种**命令按钮**组合而成，有些会根据相似的属性而将命令按钮分割成不同的**按钮组**。通过点击工具栏上面的命令按钮，用户可以很便捷地对数据进行各种变更。工具栏与工具面板比较相似，不同之处通过名字也能发现，工具栏通常是长条状，工具面板通常是面板组件。

### 工具面板

工具面板通常位于窗口侧边，当然有些编辑器允许用户任一放置工具面板的位置，工具面板可以完成比工具栏更复杂的功能，也可以简单地由相似的命令按钮组合而成。

### 导航栏

有些格式数据因为有页面之类的分隔概念，所以往往提供了导航栏来快速预览或跳转到特定部分，比如 Word 的分页。

### 内容区

内容区，不同编辑器名称不同比如图像或图形编辑器多叫**画布**，就是数据的展示区域，当然在展示区域也可以发出一些命令来对数据进行变更。

#### 标签页

现代编辑器类应用都支持同一个窗口打开多个作品了，这可以通过标签页形式来展现。

### 状态栏

通常位于窗口的底部，用来显示作品的相关状态，比如字数、字节数、光标位置、文件格式等。所以这里包含的状态一类属于作品本身的状态、一类属于编辑器本身的状态，当然也可以实现自定义显示任何状态，比如今天天气如何。

### 弹窗

弹窗主要完成非核心编辑类功能，比如编辑器设置、作品导出设置等。

### 上下文菜单

### 移动端界面

## 设计规范

## UI 组件库

## 画布

### 坐标系统

## 元素

不同编辑器名称可能不同，有些称为“对象”，是指编辑的基本单元，比如一段文本、一张图片、一个自定义元素等等。排版软件与偏设计类的也有很大不懂，比如 Word 以文本作为主要操作单元，而 PowerPoint 或者 Photoshop 以元素作为基本操作单元。设计类软件当中元素有一些基本的属性和操作：

基本属性：位置、大小

### 层叠顺序

指垂直屏幕的顺序，需要有对应的变更命令，比如：移至顶部、移至底部、移到上一层、移到下一层。Sketch 软件当中有树状对象管理器，所以可以方便的通过拖动来改变层叠顺序。

### 布局

布局应用于多个元素，主要包括**对齐**和**分布**操作。

* **对齐**：主要包括左对齐、水平居中对齐、右对齐、顶部对齐、竖直居中对齐、底部对齐。
* **分布**：是指将多个元素等距排列，包括水平和竖直两个方向。

当然，除了上面的直接命令之外，在移动元素时，有**吸附**功能来辅助布局，可以吸附到网格或者出现的一些对齐参考线上面。

### 组合

多个元素可以**组合**，组合也可以认为是元素类型，组合内的元素属性可以批量调整，比如位置、大小、填充色、字体大小等属性。当然，也可以选择组合内的单个或多个元素，然后调整其属性。另外，组合有对应的**取消组合**命令，顾名思义，取消多个元素的组合。

## 动画

## 不同类型元素

### 文本

### 图片

### 音频

### 视频

### 公式

### 表格

### 流程图

### 代码

### 自定义

## 测试

富交互应用的单元测试不是容易书写，主要是交互方式多样，需要的测试用例比较多，但是这类型的应用比起常规的 Web 项目来说更需要单元测试。一是因为本身交互多样复杂，人工测试耗时费力，而且容易遗漏；二是开发实现比较复杂，经常一个人只会实现一部分代码，需要不断地回归测试，全靠人工不太现实。

### 单元测试

测试的核心就是文章架构部分的流程图所表明的，派送一个**变更命令**（可能包含一些参数），然后经过**变更函数**执行之后，**数据**变更又导致**视图**更新。比如，可以书写不同数据的渲染视图测试，可以书写不同变更函数执行之后的数据更新结果测试。当然，除了架构流程图之外，应用可能涉及到一些工具函数、其他类也需要单元测试。

单元测试是相关功能开发人员来书写，在添加、修改功能或 bug 时也需要同步修改对应测试案例。

### E2E（端到端测试）

E2E 用于占在使用者视角来测试应用的行为，比如点击字体加粗按钮之后，画布上面的字体是否加粗。可以相关功能开发人员来书写测试脚本，也可以是专门的测试人员来书写，当然还需要提供额外的测试工具。

## 安全

## 可访问性


